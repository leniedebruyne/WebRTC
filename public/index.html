<!-- client code, desktop -->


<!DOCTYPE html>
<html>

<head>
    <title>WebRTC</title>
    <style>
        .cursor {
            position: absolute;
            width: 3rem;
            height: 3rem;
            background: red;
            border-radius: 50%;
            transition: all 0.05s linear;
        }
    </style>
</head>

<body>
    <div id="qrContainer">
        <p id="status">Scan QR code met je gsm</p>
        <div id="qr"></div>
        <a id="url" target="_blank"></a>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <script>
        const socket = io();
        const $url = document.getElementById('url');
        const $status = document.getElementById('status');
        const $qrContainer = document.getElementById('qrContainer');

        let pc = null;
        let dataChannel = null;
        let cursor = null;
        let currentControllerId = null;

        // QR code genereren
        socket.on('connect', () => {
            const desktopIP = "192.168.1.32:3000";
            const url = `http://${desktopIP}/controller.html?id=${socket.id}`;
            /* const url = `${window.location.origin}/controller.html?id=${socket.id}`; */

            $url.textContent = url;
            $url.href = url;

            const qr = qrcode(4, 'L');
            qr.addData(url);
            qr.make();
            document.getElementById('qr').innerHTML = qr.createImgTag(4);
        });

        // Offer ontvangen van controller
        socket.on('webrtc-offer', async ({ controllerId, offer }) => {

            currentControllerId = controllerId;

            pc = new RTCPeerConnection();

            pc.ondatachannel = event => {
                dataChannel = event.channel;

                dataChannel.onopen = () => {
                    $status.textContent = "Controller connected!";
                    $qrContainer.style.display = "none";
                };

                dataChannel.onmessage = e => {
                    const { x, y } = JSON.parse(e.data);

                    if (!cursor) {
                        cursor = document.createElement('div');
                        cursor.classList.add('cursor');
                        document.body.appendChild(cursor);
                    }

                    cursor.style.left = `${x * window.innerWidth}px`;
                    cursor.style.top = `${y * window.innerHeight}px`;
                };
            };

            pc.onicecandidate = e => {
                if (e.candidate) {
                    socket.emit('webrtc-ice-candidate', {
                        targetId: currentControllerId,
                        candidate: e.candidate
                    });
                }
            };

            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            socket.emit('webrtc-answer', {
                controllerId: currentControllerId,
                answer
            });
        });

        // ICE candidate ontvangen
        socket.on('webrtc-ice-candidate', async ({ candidate }) => {
            if (pc) {
                try {
                    await pc.addIceCandidate(candidate);
                } catch (err) {
                    console.error(err);
                }
            }
        });
    </script>
</body>

</html>