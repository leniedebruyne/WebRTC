<!-- client code, gsm -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controller</title>
    <style>
        #touchCursor {
            position: absolute;
            width: 3rem;
            height: 3rem;
            background: blue;
            border-radius: 50%;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <h1>Controller</h1>
    <div id="touchCursor"></div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        const desktopId = new URLSearchParams(window.location.search).get('id');
        if (!desktopId) alert("Missing desktop ID in URL!");

        const pc = new RTCPeerConnection();
        const dataChannel = pc.createDataChannel('cursor');

        dataChannel.onopen = () => console.log("Data channel open!");

        pc.onicecandidate = e => {
            if (e.candidate) {
                socket.emit('webrtc-ice-candidate', {
                    targetId: desktopId,
                    candidate: e.candidate
                });
            }
        };

        (async () => {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('webrtc-offer', { desktopId, offer });
        })();

        socket.on('webrtc-answer', ({ answer }) => {
            pc.setRemoteDescription(answer);
        });

        const $touchCursor = document.getElementById('touchCursor');

        const sendCursor = e => {
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;

            $touchCursor.style.left = `${e.clientX}px`;
            $touchCursor.style.top = `${e.clientY}px`;

            if (dataChannel.readyState === "open") {
                dataChannel.send(JSON.stringify({ x, y }));
            }
        };

        const handleTouch = e => {
            e.preventDefault();
            sendCursor(e.touches[0]);
        };

        window.addEventListener('mousemove', sendCursor);
        window.addEventListener('touchstart', handleTouch, { passive: false });
        window.addEventListener('touchmove', handleTouch, { passive: false });
    </script>
</body>

</html>